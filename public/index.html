<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Retail Team Scrum Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --brand-bg: #050816;
      --brand-accent: #3b82f6;
      --brand-accent-soft: rgba(59,130,246,0.12);
      --brand-accent-2: #22c55e;
      --brand-accent-3: #a855f7;
      --radius-xl: 22px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #020817;
      color: #0f172a;
    }

    .glass {
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(148,163,253,0.08);
    }

    .scrum-card {
      transition: all 0.18s ease;
      border-radius: 18px;
      border: 1px solid rgba(148,163,253,0.14);
      background: radial-gradient(circle at top left, rgba(59,130,246,0.06), transparent),
                  #020817;
    }
    .scrum-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 45px rgba(15,23,42,0.55);
      border-color: rgba(59,130,246,0.5);
    }

    .department-pill {
      font-size: 0.68rem;
      padding: 3px 10px;
      border-radius: 999px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,253,0.35);
      color: #e5e7eb;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
      font-size: 0.8rem;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid #020817;
      position: absolute;
      bottom: -1px;
      right: -1px;
    }

    .modal-overlay {
      background: rgba(2,6,23,0.82);
      backdrop-filter: blur(14px);
    }

    .pill {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      color: #9ca3af;
      transition: all 0.16s ease;
      background: rgba(15,23,42,0.88);
    }
    .pill span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
    }
    .pill.active {
      color: #f9fafb;
      border-color: rgba(59,130,246,0.9);
      box-shadow: 0 0 22px rgba(59,130,246,0.22);
      background: radial-gradient(circle at top, rgba(79,70,229,0.28), rgba(15,23,42,1));
    }

    .timer-active {
      box-shadow: 0 0 14px rgba(34,197,94,0.6);
    }
  </style>
</head>
<body class="min-h-screen text-slate-100">
  <div id="app" class="min-h-screen">
    <!-- TOP BAR -->
    <header class="w-full border-b border-slate-800 bg-gradient-to-r from-slate-950 via-slate-900 to-slate-950">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-blue-500 via-indigo-500 to-violet-500
                      flex items-center justify-center font-extrabold text-slate-900 text-lg shadow-lg">
            S
          </div>
          <div>
            <div class="flex items-center gap-2">
              <h1 id="portal-title" class="text-lg sm:text-xl font-semibold tracking-tight">
                Retail Team Scrum Portal
              </h1>
              <span class="text-[0.7rem] px-2 py-0.5 rounded-full bg-slate-900/80 border border-indigo-500/40 text-indigo-300">
                live
              </span>
            </div>
            <p id="current-date" class="text-xs text-slate-400"></p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <div id="timer-display"
               class="hidden items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900/85 border border-slate-700 text-xs">
            <span class="text-slate-400">Standup timer</span>
            <span id="timer-text" class="font-semibold text-emerald-400">15:00</span>
          </div>

          <button id="start-scrum-btn"
                  class="px-3 py-1.5 rounded-full bg-gradient-to-r from-blue-500 to-indigo-500
                         text-xs font-semibold text-slate-950 shadow-md hover:shadow-blue-500/30
                         transition-all flex items-center gap-1.5">
            üöÄ Start Scrum
          </button>

          <button id="add-update-btn"
                  class="px-3 py-1.5 rounded-full bg-slate-900/90 border border-slate-700 text-xs
                         font-medium text-slate-200 hover:border-indigo-500/70 hover:text-indigo-300
                         flex items-center gap-1.5 transition-all">
            ‚ûï <span>Add update</span>
          </button>
        </div>
      </div>

      <!-- TABS & PILLS -->
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-4 text-xs">
          <button class="tab-btn pill active" data-tab="dashboard">
            <span class="dot bg-blue-500"></span> Board
          </button>
          <button class="tab-btn pill" data-tab="summary">
            <span class="dot bg-emerald-400"></span> Summary
          </button>
          <button class="tab-btn pill" data-tab="manager">
            <span class="dot bg-violet-400"></span> Manager view
          </button>
        </div>

        <div class="hidden md:flex items-center gap-2 text-[0.68rem] text-slate-500">
          <span class="px-2 py-0.5 rounded-full bg-slate-900/80 border border-slate-700">
            ‚è±Ô∏è 15-min async+live standup
          </span>
          <span class="px-2 py-0.5 rounded-full bg-slate-900/80 border border-slate-700">
            üîê Backed by Supabase
          </span>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <!-- DASHBOARD TAB -->
      <section id="dashboard-tab" class="tab-content">
        <div class="flex items-center justify-between gap-3 mb-4">
          <div>
            <h2 class="text-base sm:text-lg font-semibold text-slate-50">Today's standup</h2>
            <p class="text-xs text-slate-400">
              Quick visual of what everyone is doing, in a clean board-style layout.
            </p>
          </div>
        </div>

        <div id="team-updates" class="grid gap-4 md:grid-cols-2 xl:grid-cols-3"></div>

        <div id="empty-state"
             class="mt-8 flex flex-col items-center justify-center gap-3 py-10
                    glass rounded-3xl border border-dashed border-slate-700">
          <div class="w-12 h-12 rounded-2xl bg-slate-900 flex items-center justify-center text-2xl">
            üìù
          </div>
          <h3 class="text-sm font-medium text-slate-100">No updates yet for today</h3>
          <p class="text-xs text-slate-400">Kick things off by adding the first standup entry.</p>
          <button class="add-update-trigger px-3 py-1.5 rounded-full bg-gradient-to-r from-blue-500 to-indigo-500
                         text-xs font-semibold text-slate-950 shadow hover:shadow-blue-500/30 transition-all">
            Add first update
          </button>
        </div>
      </section>

      <!-- SUMMARY TAB -->
      <section id="summary-tab" class="tab-content hidden">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 mb-4">
          <div>
            <h2 class="text-base sm:text-lg font-semibold text-slate-50">Daily summary</h2>
            <p class="text-xs text-slate-400">
              Snapshot by person for a specific date. Perfect for leadership recap.
            </p>
          </div>
          <div class="flex items-center gap-2">
            <input type="date"
                   id="summary-date"
                   class="px-3 py-1.5 text-xs rounded-full bg-slate-950 border border-slate-700
                          text-slate-200 focus:outline-none focus:ring-1 focus:ring-blue-500" />
            <button id="export-btn"
                    class="px-3 py-1.5 rounded-full bg-emerald-500/95 hover:bg-emerald-400
                           text-[0.7rem] font-semibold text-slate-950 flex items-center gap-1.5">
              üìÑ Export CSV
            </button>
          </div>
        </div>
        <div id="summary-content" class="space-y-4"></div>
      </section>

      <!-- MANAGER TAB -->
      <section id="manager-tab" class="tab-content hidden">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 mb-3">
          <div>
            <h2 class="text-base sm:text-lg font-semibold text-slate-50">Manager view</h2>
            <p class="text-xs text-slate-400">
              Filter by member, department or date. Quickly see blockers and activity.
            </p>
          </div>
        </div>

        <div class="glass rounded-3xl p-4 mb-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
            <select id="filter-member"
                    class="w-full px-3 py-1.5 text-xs rounded-full bg-slate-950 border border-slate-700
                           text-slate-200 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="">All team members</option>
            </select>

            <select id="filter-department"
                    class="w-full px-3 py-1.5 text-xs rounded-full bg-slate-950 border border-slate-700
                           text-slate-200 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="">All departments</option>
              <option value="Management">Management</option>
              <option value="Retail / MM">Retail / MM</option>
              <option value="E-commerce">E-commerce</option>
              <option value="Logistics">Logistics</option>
              <option value="Fulfillment">Fulfillment</option>
              <option value="Customer Exp">Customer Exp</option>
            </select>

            <input type="date"
                   id="filter-date"
                   class="w-full px-3 py-1.5 text-xs rounded-full bg-slate-950 border border-slate-700
                          text-slate-200 focus:outline-none focus:ring-1 focus:ring-blue-500" />
          </div>

          <div id="blocker-escalation-area" class="text-xs"></div>
        </div>

        <div id="manager-content" class="space-y-3"></div>
      </section>
    </main>

    <!-- CREATE / EDIT MODAL -->
    <div id="update-modal"
         class="fixed inset-0 z-40 hidden modal-overlay flex items-center justify-center px-3">
      <div class="glass rounded-3xl max-w-xl w-full max-h-[90vh] overflow-y-auto p-5">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h3 id="modal-title" class="text-sm font-semibold text-slate-50">
              New standup update
            </h3>
            <p class="text-[0.7rem] text-slate-500">
              Capture yesterday, today, and blockers in one quick form.
            </p>
          </div>
          <button id="close-modal"
                  class="w-7 h-7 rounded-full bg-slate-900 flex items-center justify-center
                         text-slate-400 hover:text-red-400 hover:bg-slate-800 text-sm">
            ‚úï
          </button>
        </div>

        <form id="update-form" class="space-y-3 text-[0.72rem]">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block mb-1 text-slate-400">Date</label>
              <input type="date" id="update-date" name="date" required
                     class="w-full px-3 py-1.5 rounded-xl bg-slate-950 border border-slate-700
                            text-slate-100 focus:outline-none focus:ring-1 focus:ring-blue-500" />
            </div>
            <div>
              <label class="block mb-1 text-slate-400">Team member</label>
              <select id="team-member" name="team_member" required
                      class="w-full px-3 py-1.5 rounded-xl bg-slate-950 border border-slate-700
                             text-slate-100 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <option value="">Select</option>
                <option value="Amrit">Amrit</option>
                <option value="Vihan">Vihan</option>
                <option value="Maricel">Maricel</option>
                <option value="Kunal">Kunal</option>
                <option value="Mehboob">Mehboob</option>
                <option value="Aaron">Aaron</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block mb-1 text-slate-400">Department</label>
            <select id="department" name="department" required
                    class="w-full px-3 py-1.5 rounded-xl bg-slate-950 border border-slate-700
                           text-slate-100 focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="">Select department</option>
              <option value="Management">Management</option>
              <option value="Retail / MM">Retail / MM</option>
              <option value="E-commerce">E-commerce</option>
              <option value="Logistics">Logistics</option>
              <option value="Fulfillment">Fulfillment</option>
              <option value="Customer Exp">Customer Exp</option>
            </select>
          </div>

          <div>
            <label class="block mb-1 text-slate-400">Yesterday's work</label>
            <textarea id="yesterday-work" name="yesterday_work" rows="2"
                      placeholder="What did you complete?"
                      class="w-full px-3 py-1.5 rounded-xl bg-slate-950 border border-slate-700
                             text-slate-100 resize-none focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
          </div>

          <div>
            <label class="block mb-1 text-slate-400">Today's plan</label>
            <textarea id="today-plan" name="today_plan" rows="2"
                      placeholder="What will you work on?"
                      class="w-full px-3 py-1.5 rounded-xl bg-slate-950 border border-slate-700
                             text-slate-100 resize-none focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
          </div>

          <div>
            <label class="block mb-1 text-slate-400">Blockers</label>
            <textarea id="blockers" name="blockers" rows="2"
                      placeholder="Any risks, delays, dependencies?"
                      class="w-full px-3 py-1.5 rounded-xl bg-slate-950 border border-slate-700
                             text-slate-100 resize-none focus:outline-none focus:ring-1 focus:ring-rose-500/70"></textarea>
          </div>

          <div>
            <label class="block mb-1 text-slate-400">Remarks / notes</label>
            <textarea id="remarks" name="remarks" rows="2"
                      placeholder="Optional context for leads"
                      class="w-full px-3 py-1.5 rounded-xl bg-slate-950 border border-slate-700
                             text-slate-100 resize-none focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
          </div>

          <div class="flex justify-between items-center pt-2 gap-3">
            <button type="button" id="cancel-btn"
                    class="px-3 py-1.5 rounded-full bg-slate-900 text-slate-400 text-[0.7rem]
                           hover:bg-slate-800 hover:text-slate-200">
              Cancel
            </button>
            <div class="flex items-center gap-2">
              <span id="edit-hint"
                    class="hidden text-[0.65rem] px-2 py-0.5 rounded-full bg-slate-900 text-amber-300 border border-amber-500/40">
                Editing existing entry
              </span>
              <button type="submit" id="save-btn"
                      class="px-4 py-1.5 rounded-full bg-gradient-to-r from-blue-500 to-indigo-500
                             text-[0.7rem] font-semibold text-slate-950 flex items-center gap-1.5
                             hover:shadow-lg hover:shadow-blue-500/40 transition-all">
                <span id="save-text">Save update</span>
                <span id="save-loading" class="hidden">Saving‚Ä¶</span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    // ================== CONFIG ==================
    const defaultConfig = {
      meeting_duration: 15
    };

    // TODO: set these to your actual Supabase project values
    const SUPABASE_URL = "https://vzyiwazyqqgznyqfcbtt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eWl3YXp5cXFnem55cWZjYnR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDAwMjQsImV4cCI6MjA3ODA3NjAyNH0.lGitaQYnskj8OcMR9MDsPL1n8oMOxunMQKwyjJEPOyg";

    const supabaseHeaders = {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY,
      "Content-Type": "application/json",
      "Prefer": "return=representation"
    };

    const teamMembers = {
      "Amrit":   { department: "Management",   color: "#38bdf8" },
      "Vihan":   { department: "Retail / MM",  color: "#22c55e" },
      "Maricel": { department: "E-commerce",   color: "#fb923c" },
      "Kunal":   { department: "Logistics",    color: "#6366f1" },
      "Mehboob": { department: "Fulfillment",  color: "#a855f7" },
      "Aaron":   { department: "Customer Exp", color: "#f97316" }
    };

    let currentData = [];
    let timerInterval = null;
    let timerSeconds = 0;
    let isTimerRunning = false;
    let activeEditId = null;

    function esc(str) {
      return (str || "")
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    // ============ Supabase data SDK ============
    window.dataSdk = {
      _handler: null,

      async init(handler) {
        this._handler = handler;

        const url =
          `${SUPABASE_URL}/rest/v1/scrum_updates` +
          `?select=id,date,team_member,department,yesterday_work,today_plan,blockers,remarks,created_at` +
          `&order=date.desc,created_at.desc`;

        try {
          const resp = await fetch(url, { headers: supabaseHeaders });
          if (!resp.ok) {
            console.error("Supabase GET failed", await resp.text());
            handler.onDataChanged([]);
            return { isOk: false };
          }
          const rows = await resp.json();

          const mapped = rows.map(r => ({
            id: r.id,
            date: r.date,
            team_member: r.team_member,
            department: r.department,
            yesterday_work: r.yesterday_work,
            today_plan: r.today_plan,
            blockers: r.blockers,
            remarks: r.remarks,
            created_at: r.created_at
          }));

          handler.onDataChanged(mapped);
          return { isOk: true };
        } catch (err) {
          console.error("Supabase init error", err);
          handler.onDataChanged([]);
          return { isOk: false };
        }
      },

      async create(row) {
        try {
          const resp = await fetch(
            `${SUPABASE_URL}/rest/v1/scrum_updates`,
            {
              method: "POST",
              headers: supabaseHeaders,
              body: JSON.stringify(row)
            }
          );

          if (!resp.ok) {
            console.error("Supabase INSERT failed:", await resp.text());
            return { isOk: false };
          }

          await this.init(this._handler);
          return { isOk: true };
        } catch (err) {
          console.error("Supabase create error", err);
          return { isOk: false };
        }
      },

      async update(id, partial) {
        try {
          const resp = await fetch(
            `${SUPABASE_URL}/rest/v1/scrum_updates?id=eq.${encodeURIComponent(id)}`,
            {
              method: "PATCH",
              headers: supabaseHeaders,
              body: JSON.stringify(partial)
            }
          );

          if (!resp.ok) {
            console.error("Supabase UPDATE failed:", await resp.text());
            return { isOk: false };
          }

          await this.init(this._handler);
          return { isOk: true };
        } catch (err) {
          console.error("Supabase update error", err);
          return { isOk: false };
        }
      }
    };

    const dataHandler = {
      onDataChanged(data) {
        currentData = data;
        updateUI();
      }
    };

    // ============ INIT ============
    document.addEventListener("DOMContentLoaded", initializeApp);

    async function initializeApp() {
      updateCurrentDate();
      updateTimerDisplay();
      setupStaticListeners();

      const today = new Date().toISOString().split("T")[0];
      document.getElementById("update-date").value = today;
      document.getElementById("summary-date").value = today;
      document.getElementById("filter-date").value = today;

      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        console.error("Failed to init data from Supabase");
      }
    }

    // ============ LISTENERS ============
    function setupStaticListeners() {
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.addEventListener("click", () => switchTab(btn.dataset.tab));
      });

      document.getElementById("add-update-btn")
        .addEventListener("click", () => openModal());
      document.querySelector(".add-update-trigger")
        ?.addEventListener("click", () => openModal());

      document.getElementById("close-modal").addEventListener("click", closeModal);
      document.getElementById("cancel-btn").addEventListener("click", closeModal);

      document.getElementById("update-form").addEventListener("submit", handleFormSubmit);

      document.getElementById("start-scrum-btn").addEventListener("click", toggleTimer);

      document.getElementById("filter-member").addEventListener("change", applyFilters);
      document.getElementById("filter-department").addEventListener("change", applyFilters);
      document.getElementById("filter-date").addEventListener("change", applyFilters);

      document.getElementById("summary-date").addEventListener("change", updateSummaryView);
      document.getElementById("export-btn").addEventListener("click", exportSummary);
    }

    // ============ FORM SUBMIT (CREATE / EDIT) ============
    async function handleFormSubmit(e) {
      e.preventDefault();

      if (currentData.length >= 999) {
        showToast("Max 999 updates reached. Clean up old entries.", "error");
        return;
      }

      const saveBtn = document.getElementById("save-btn");
      const saveText = document.getElementById("save-text");
      const saveLoading = document.getElementById("save-loading");

      saveBtn.disabled = true;
      saveText.classList.add("hidden");
      saveLoading.classList.remove("hidden");

      try {
        const formData = new FormData(e.target);
        const payload = {
          date: formData.get("date"),
          team_member: formData.get("team_member"),
          department: formData.get("department"),
          yesterday_work: formData.get("yesterday_work") || "",
          today_plan: formData.get("today_plan") || "",
          blockers: formData.get("blockers") || "",
          remarks: formData.get("remarks") || "",
          created_at: new Date().toISOString()
        };

        let result;
        if (activeEditId) {
          // EDIT
          delete payload.created_at; // don't overwrite original created_at
          result = await window.dataSdk.update(activeEditId, payload);
        } else {
          // CREATE
          result = await window.dataSdk.create(payload);
        }

        if (result.isOk) {
          closeModal();
          showToast(activeEditId ? "Update saved." : "New entry added.", "success");
        } else {
          showToast("Failed to save update. Check console / Supabase config.", "error");
        }
      } catch (err) {
        console.error(err);
        showToast("Unexpected error while saving.", "error");
      } finally {
        saveBtn.disabled = false;
        saveText.classList.remove("hidden");
        saveLoading.classList.add("hidden");
      }
    }

    // ============ RENDERING ============
    function updateUI() {
      updateDashboard();
      updateManagerPanel();
      updateSummaryView();
    }

    function updateDashboard() {
      const container = document.getElementById("team-updates");
      const emptyState = document.getElementById("empty-state");
      const today = new Date().toISOString().split("T")[0];

      const todayUpdates = currentData.filter(u => u.date === today);

      if (!todayUpdates.length) {
        container.innerHTML = "";
        emptyState.classList.remove("hidden");
        return;
      }

      emptyState.classList.add("hidden");

      // latest per member
      const latestByMember = {};
      todayUpdates.forEach(u => {
        if (!latestByMember[u.team_member] ||
            new Date(u.created_at) > new Date(latestByMember[u.team_member].created_at)) {
          latestByMember[u.team_member] = u;
        }
      });

      container.innerHTML = Object.values(latestByMember)
        .map(u => createUpdateCard(u))
        .join("");

      // attach edit handlers
      container.querySelectorAll("[data-edit-id]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.editId;
          const row = currentData.find(r => r.id === id);
          if (row) openModal(row);
        });
      });
    }

    function createUpdateCard(update) {
      const memberInfo = teamMembers[update.team_member] ||
        { department: update.department || "", color: "#64748b" };
      const hasBlockers = !!(update.blockers && update.blockers.trim());
      const initials = update.team_member
        ? update.team_member.split(" ").map(n => n[0]).join("")
        : "?";

      return `
        <article class="scrum-card p-4 flex flex-col gap-3">
          <div class="flex items-start justify-between gap-2">
            <div class="flex items-center gap-2.5">
              <div class="relative">
                <div class="avatar"
                     style="background: linear-gradient(135deg, ${memberInfo.color}, #111827);">
                  ${esc(initials)}
                </div>
                <div class="status-indicator ${hasBlockers ? "bg-rose-500" : "bg-emerald-400"}"></div>
              </div>
              <div class="flex flex-col">
                <div class="flex items-center gap-1.5">
                  <h3 class="text-xs font-semibold text-slate-50">
                    ${esc(update.team_member || "Unassigned")}
                  </h3>
                  ${hasBlockers ? `
                    <span class="px-1.5 py-0.5 rounded-full bg-rose-500/20 text-[0.55rem] text-rose-300">
                      ‚ö† Blocker
                    </span>` : `
                    <span class="px-1.5 py-0.5 rounded-full bg-emerald-500/15 text-[0.55rem] text-emerald-300">
                      ‚úì Clear
                    </span>`}
                </div>
                <span class="department-pill">
                  <span class="w-1.5 h-1.5 rounded-full"
                        style="background-color:${memberInfo.color};"></span>
                  ${esc(update.department || memberInfo.department || "Dept")}
                </span>
              </div>
            </div>
            <button class="text-[0.6rem] px-2 py-1 rounded-full bg-slate-900/90 text-slate-400
                           hover:text-blue-400 hover:bg-slate-800 transition-all"
                    data-edit-id="${esc(update.id)}">
              ‚úè Edit
            </button>
          </div>

          <div class="space-y-1.5 text-[0.68rem]">
            <div>
              <p class="text-slate-500">Yesterday</p>
              <p class="text-slate-100">
                ${esc(update.yesterday_work || "No update provided.")}
              </p>
            </div>
            <div>
              <p class="text-slate-500">Today</p>
              <p class="text-slate-100">
                ${esc(update.today_plan || "No plan specified.")}
              </p>
            </div>
            <div>
              <p class="text-slate-500">Blockers</p>
              <p class="${hasBlockers ? "text-rose-300" : "text-slate-600"}">
                ${esc(update.blockers || "None")}
              </p>
            </div>
            ${update.remarks ? `
              <div>
                <p class="text-slate-500">Notes</p>
                <p class="text-indigo-200">${esc(update.remarks)}</p>
              </div>` : ""}
          </div>

          <div class="flex justify-between items-center text-[0.6rem] text-slate-500 pt-1">
            <span>${new Date(update.date || update.created_at).toLocaleDateString()}</span>
            <span>
              ${update.created_at
                ? new Date(update.created_at).toLocaleTimeString("en-US", {hour:"2-digit", minute:"2-digit"})
                : ""}
            </span>
          </div>
        </article>
      `;
    }

    function updateSummaryView() {
      const selectedDate = document.getElementById("summary-date").value;
      const container = document.getElementById("summary-content");
      if (!selectedDate) return;

      const dayUpdates = currentData.filter(u => u.date === selectedDate);

      if (!dayUpdates.length) {
        container.innerHTML = `
          <div class="glass rounded-3xl p-6 flex flex-col items-center gap-2">
            <div class="w-10 h-10 rounded-2xl bg-slate-900 flex items-center justify-center text-2xl">üìÖ</div>
            <p class="text-sm text-slate-200">No updates for ${esc(selectedDate)}.</p>
            <p class="text-[0.7rem] text-slate-500">
              Ask the team to submit standup entries, or pick another date.
            </p>
          </div>`;
        return;
      }

      const groups = {};
      dayUpdates.forEach(u => {
        if (!groups[u.team_member]) groups[u.team_member] = [];
        groups[u.team_member].push(u);
      });

      container.innerHTML = `
        <div class="glass rounded-3xl p-5 space-y-4">
          <h3 class="text-sm font-semibold text-slate-50">
            Standup summary ‚Äî ${
              new Date(selectedDate).toLocaleDateString("en-US", {
                weekday:"long", month:"short", day:"numeric", year:"numeric"
              })
            }
          </h3>
          ${
            Object.entries(groups).map(([member, list]) => {
              const latest = list.sort((a,b) =>
                new Date(b.created_at) - new Date(a.created_at))[0];
              const info = teamMembers[member] || {color:"#64748b"};

              return `
                <div class="border-l-2 pl-3 space-y-1.5"
                     style="border-color:${info.color};">
                  <div class="flex items-center gap-2">
                    <span class="text-[0.8rem] font-semibold text-slate-100">
                      ${esc(member || "Unassigned")}
                    </span>
                    <span class="text-[0.6rem] px-2 py-0.5 rounded-full
                                 bg-slate-900 text-slate-300 border border-slate-700">
                      ${esc(latest.department || "Dept")}
                    </span>
                  </div>
                  <div class="grid md:grid-cols-3 gap-2 text-[0.68rem]">
                    <div>
                      <div class="text-slate-500">Yesterday</div>
                      <div class="text-slate-100">
                        ${esc(latest.yesterday_work || "No update")}
                      </div>
                    </div>
                    <div>
                      <div class="text-slate-500">Today</div>
                      <div class="text-slate-100">
                        ${esc(latest.today_plan || "No plan")}
                      </div>
                    </div>
                    <div>
                      <div class="text-slate-500">Blockers</div>
                      <div class="${latest.blockers ? "text-rose-300" : "text-slate-500"}">
                        ${esc(latest.blockers || "None")}
                      </div>
                    </div>
                  </div>
                  ${latest.remarks ? `
                    <div class="text-[0.65rem] text-indigo-200">
                      Notes: ${esc(latest.remarks)}
                    </div>` : ""}
                </div>
              `;
            }).join("")
          }
        </div>
      `;
    }

    function updateManagerPanel() {
      populateFilterDropdowns();
      applyFilters();
    }

    function populateFilterDropdowns() {
      const memberSelect = document.getElementById("filter-member");
      const unique = [...new Set(currentData.map(u => u.team_member).filter(Boolean))];

      memberSelect.innerHTML =
        `<option value="">All team members</option>` +
        unique.map(m => `<option value="${esc(m)}">${esc(m)}</option>`).join("");
    }

    function applyFilters() {
      const member = document.getElementById("filter-member").value;
      const dept = document.getElementById("filter-department").value;
      const date = document.getElementById("filter-date").value;

      let items = [...currentData];

      if (member) items = items.filter(u => u.team_member === member);
      if (dept) items = items.filter(u => u.department === dept);
      if (date) items = items.filter(u => u.date === date);

      displayManagerContent(items);
    }

    function displayManagerContent(data) {
      const container = document.getElementById("manager-content");
      const blockerArea = document.getElementById("blocker-escalation-area");

      if (!data.length) {
        blockerArea.innerHTML = "";
        container.innerHTML = `
          <div class="glass rounded-3xl p-6 flex flex-col items-center gap-2">
            <div class="w-10 h-10 rounded-2xl bg-slate-900 flex items-center justify-center text-2xl">üîç</div>
            <p class="text-sm text-slate-200">No entries match the current filters.</p>
            <p class="text-[0.7rem] text-slate-500">Adjust filters to see more.</p>
          </div>`;
        return;
      }

      const openBlockers = data.filter(u => u.blockers && u.blockers.trim());
      if (openBlockers.length) {
        blockerArea.innerHTML = `
          <div class="rounded-2xl bg-rose-500/10 border border-rose-500/40 px-3 py-2 text-[0.65rem] text-rose-200">
            <div class="font-semibold mb-1 flex items-center gap-1.5">
              üö® ${openBlockers.length} blocker${openBlockers.length>1?"s":""} need attention
            </div>
            <ul class="list-disc pl-4 space-y-0.5">
              ${
                openBlockers.slice(0,6).map(b => `
                  <li>
                    <span class="font-semibold">${esc(b.team_member)}</span>
                    <span class="text-slate-400">(${esc(b.department || "")})</span> ‚Äî
                    ${esc(b.blockers)}
                  </li>`).join("")
              }
            </ul>
          </div>`;
      } else {
        blockerArea.innerHTML = "";
      }

      const total = data.length;
      const uniqueMembers = new Set(data.map(u => u.team_member)).size;

      container.innerHTML = `
        <div class="grid grid-cols-3 gap-2 mb-3 text-[0.65rem]">
          <div class="glass rounded-2xl px-3 py-2">
            <div class="text-slate-400">Total updates</div>
            <div class="text-lg font-semibold text-slate-50">${total}</div>
          </div>
          <div class="glass rounded-2xl px-3 py-2">
            <div class="text-slate-400">Active members</div>
            <div class="text-lg font-semibold text-emerald-400">${uniqueMembers}</div>
          </div>
          <div class="glass rounded-2xl px-3 py-2">
            <div class="text-slate-400">Open blockers</div>
            <div class="text-lg font-semibold ${openBlockers.length ? "text-rose-400" : "text-slate-400"}">
              ${openBlockers.length}
            </div>
          </div>
        </div>

        <div class="space-y-2">
          ${
            data.map(u => {
              const info = teamMembers[u.team_member] || {color:"#64748b"};
              const hasBlockers = u.blockers && u.blockers.trim();
              const initials = u.team_member
                ? u.team_member.split(" ").map(n => n[0]).join("")
                : "?";
              return `
                <div class="glass rounded-2xl px-3 py-2 flex flex-col gap-1.5 text-[0.65rem]">
                  <div class="flex items-start justify-between gap-2">
                    <div class="flex items-center gap-2">
                      <div class="w-7 h-7 rounded-xl flex items-center justify-center text-[0.6rem] text-white"
                           style="background: linear-gradient(135deg, ${info.color}, #020817);">
                        ${esc(initials)}
                      </div>
                      <div>
                        <div class="flex items-center gap-1.5">
                          <span class="font-semibold text-slate-50">${esc(u.team_member || "Unassigned")}</span>
                          <span class="px-1.5 py-0.5 rounded-full bg-slate-950 text-slate-400 border border-slate-700">
                            ${esc(u.department || "")}
                          </span>
                        </div>
                        <div class="text-slate-500">
                          ${esc(u.date || "")}
                          ${hasBlockers ? " ‚Ä¢ ‚ö† Blocker" : ""}
                        </div>
                      </div>
                    </div>
                    <button class="px-2 py-0.5 rounded-full bg-slate-900 text-slate-400 hover:text-blue-400
                                   hover:bg-slate-800 transition-all"
                            data-edit-id="${esc(u.id)}">
                      Edit
                    </button>
                  </div>
                  <div class="grid md:grid-cols-2 gap-1.5">
                    <div>
                      <span class="text-slate-500">Yesterday:</span>
                      <span class="text-slate-100"> ${esc(u.yesterday_work || "‚Äî")} </span>
                    </div>
                    <div>
                      <span class="text-slate-500">Today:</span>
                      <span class="text-slate-100"> ${esc(u.today_plan || "‚Äî")} </span>
                    </div>
                  </div>
                  ${
                    hasBlockers ? `
                      <div class="text-rose-300">
                        <span class="text-rose-400">Blocker:</span> ${esc(u.blockers)}
                      </div>` : ""
                  }
                  ${
                    u.remarks ? `
                      <div class="text-indigo-200">
                        <span class="text-indigo-400">Notes:</span> ${esc(u.remarks)}
                      </div>` : ""
                  }
                </div>
              `;
            }).join("")
          }
        </div>
      `;

      // wire edit buttons here too
      container.querySelectorAll("[data-edit-id]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.editId;
          const row = currentData.find(r => r.id === id);
          if (row) openModal(row);
        });
      });
    }

    // ============ EXPORT CSV ============
    function exportSummary() {
      const selectedDate = document.getElementById("summary-date").value;
      if (!selectedDate) {
        showToast("Pick a date first.", "error");
        return;
      }

      const rows = currentData.filter(u => u.date === selectedDate);
      if (!rows.length) {
        showToast("No data for that date.", "error");
        return;
      }

      const headers = [
        "date",
        "team_member",
        "department",
        "yesterday_work",
        "today_plan",
        "blockers",
        "remarks"
      ];

      const lines = [
        headers.join(","),
        ...rows.map(r => [
          r.date,
          r.team_member,
          r.department,
          (r.yesterday_work || "").replace(/"/g, '""'),
          (r.today_plan || "").replace(/"/g, '""'),
          (r.blockers || "").replace(/"/g, '""'),
          (r.remarks || "").replace(/"/g, '""'),
        ].map(v => `"${v || ""}"`).join(","))
      ];

      const blob = new Blob([lines.join("\n")], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `scrum-summary-${selectedDate}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast("Summary exported.", "success");
    }

    // ============ UTILITIES ============
    function updateCurrentDate() {
      const now = new Date();
      document.getElementById("current-date").textContent =
        now.toLocaleDateString("en-US", {
          weekday:"long", month:"short", day:"numeric", year:"numeric"
        });
    }

    function toggleTimer() {
      const btn = document.getElementById("start-scrum-btn");
      const timerDisplay = document.getElementById("timer-display");

      if (!isTimerRunning) {
        timerSeconds = defaultConfig.meeting_duration * 60;
        isTimerRunning = true;
        btn.textContent = "‚èπ Stop Scrum";
        btn.classList.add("timer-active");
        timerDisplay.classList.remove("hidden");

        timerInterval = setInterval(() => {
          timerSeconds--;
          updateTimerDisplay();
          if (timerSeconds <= 0) {
            clearInterval(timerInterval);
            isTimerRunning = false;
            btn.textContent = "üöÄ Start Scrum";
            btn.classList.remove("timer-active");
            timerDisplay.classList.add("hidden");
            showToast("Standup timer finished.", "success");
          }
        }, 1000);
      } else {
        clearInterval(timerInterval);
        isTimerRunning = false;
        btn.textContent = "üöÄ Start Scrum";
        btn.classList.remove("timer-active");
        timerDisplay.classList.add("hidden");
      }
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(timerSeconds / 60);
      const seconds = timerSeconds % 60;
      const s = `${String(minutes).padStart(2,"0")}:${String(seconds).padStart(2,"0")}`;
      const el = document.getElementById("timer-text");
      if (el) el.textContent = s;
    }

    function switchTab(tabName) {
      document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.remove("active");
        btn.classList.remove("pill-active");
        btn.classList.remove("bg-blue-500");
      });

      const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
      if (activeBtn) activeBtn.classList.add("active");

      document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
      const target = document.getElementById(`${tabName}-tab`);
      if (target) target.classList.remove("hidden");

      if (tabName === "summary") updateSummaryView();
      if (tabName === "manager") updateManagerPanel();
    }

    function showToast(message, type="info") {
      const toast = document.createElement("div");
      toast.className =
        "fixed top-4 right-4 z-50 px-3 py-2 rounded-2xl text-[0.7rem] font-medium" +
        " shadow-lg shadow-slate-900/80 transform translate-x-full opacity-0 transition-all";

      const colors = {
        success: "bg-emerald-500 text-slate-950",
        error: "bg-rose-500 text-slate-950",
        info: "bg-blue-500 text-slate-950"
      };
      toast.classList.add(colors[type] || colors.info);
      toast.textContent = message;
      document.body.appendChild(toast);

      requestAnimationFrame(() => {
        toast.classList.remove("translate-x-full", "opacity-0");
      });

      setTimeout(() => {
        toast.classList.add("translate-x-full", "opacity-0");
        setTimeout(() => toast.remove(), 220);
      }, 2600);
    }

    function openModal(existing) {
      const modal = document.getElementById("update-modal");
      const title = document.getElementById("modal-title");
      const editHint = document.getElementById("edit-hint");
      const saveText = document.getElementById("save-text");

      if (existing) {
        activeEditId = existing.id;
        title.textContent = "Edit standup update";
        editHint.classList.remove("hidden");
        saveText.textContent = "Save changes";

        document.getElementById("update-date").value = existing.date || "";
        document.getElementById("team-member").value = existing.team_member || "";
        document.getElementById("department").value = existing.department || "";
        document.getElementById("yesterday-work").value = existing.yesterday_work || "";
        document.getElementById("today-plan").value = existing.today_plan || "";
        document.getElementById("blockers").value = existing.blockers || "";
        document.getElementById("remarks").value = existing.remarks || "";
      } else {
        activeEditId = null;
        title.textContent = "New standup update";
        editHint.classList.add("hidden");
        saveText.textContent = "Save update";

        const today = new Date().toISOString().split("T")[0];
        document.getElementById("update-date").value = today;
        document.getElementById("team-member").value = "";
        document.getElementById("department").value = "";
        document.getElementById("yesterday-work").value = "";
        document.getElementById("today-plan").value = "";
        document.getElementById("blockers").value = "";
        document.getElementById("remarks").value = "";
      }

      modal.classList.remove("hidden");
    }

    function closeModal() {
      activeEditId = null;
      document.getElementById("update-modal").classList.add("hidden");
    }
  </script>
</body>
</html>
