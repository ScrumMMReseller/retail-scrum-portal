<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Retail Team Scrum Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      /* ClickUp-ish light palette */
      --brand-bg: #f9fafb;
      --brand-surface: #ffffff;
      --brand-border-subtle: #e5e7eb;
      --brand-text-main: #0f172a;
      --brand-muted: #6b7280;
      --brand-accent: #7c3aed;       /* purple */
      --brand-accent-2: #22c55e;     /* green */
      --brand-accent-3: #06b6d4;     /* teal/blue */
      --brand-accent-soft: rgba(124, 58, 237, 0.06);
      --radius-xl: 24px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--brand-bg);
      color: var(--brand-text-main);
      font-size: 15px;
    }

    header {
      background: linear-gradient(to right, #ffffff, #faf5ff);
      border-bottom: 1px solid var(--brand-border-subtle);
    }

    .glass {
      background: var(--brand-surface);
      border-radius: var(--radius-xl);
      border: 1px solid var(--brand-border-subtle);
      box-shadow: 0 10px 30px rgba(15,23,42,0.04);
    }

    .scrum-card {
      transition: all 0.18s ease;
      border-radius: 22px;
      border: 1px solid var(--brand-border-subtle);
      background:
        radial-gradient(circle at top left, var(--brand-accent-soft), transparent),
        var(--brand-surface);
      box-shadow: 0 6px 18px rgba(15,23,42,0.04);
    }

    .scrum-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 18px 40px rgba(15,23,42,0.10);
      border-color: rgba(124,58,237,0.35);
    }

    .department-pill {
      font-size: 0.75rem;
      padding: 3px 10px;
      border-radius: 999px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      color: var(--brand-muted);
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #ffffff;
      font-size: 0.9rem;
      background: linear-gradient(135deg, var(--brand-accent), var(--brand-accent-3));
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid #ffffff;
      position: absolute;
      bottom: -1px;
      right: -1px;
    }

    .modal-overlay {
      background: rgba(15,23,42,0.22);
      backdrop-filter: blur(6px);
    }

    .pill {
      padding: 7px 16px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      color: var(--brand-muted);
      transition: all 0.16s ease;
      background: #f3f4ff;
    }

    .pill span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background-color: var(--brand-accent);
    }

    .pill.active {
      color: var(--brand-accent);
      border-color: rgba(124,58,237,0.7);
      box-shadow: 0 0 18px rgba(124,58,237,0.18);
      background: #ffffff;
    }

    .timer-active {
      box-shadow: 0 0 14px rgba(34,197,94,0.28);
    }

    .text-label {
      font-size: 0.8rem;
      color: var(--brand-muted);
      font-weight: 500;
    }

    .field-input,
    .field-textarea,
    .field-select {
      width: 100%;
      border-radius: 14px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 0.85rem;
      color: var(--brand-text-main);
      background: #ffffff;
      outline: none;
      transition: all 0.16s ease;
    }

    .field-input:focus,
    .field-textarea:focus,
    .field-select:focus {
      border-color: var(--brand-accent);
      box-shadow: 0 0 0 1px rgba(124,58,237,0.18);
    }

    .field-textarea {
      resize: vertical;
      min-height: 68px;
    }

    /* preserve bullets & line breaks for content text */
    .multiline {
      white-space: pre-line;
    }
  </style>
</head>
<body class="min-h-screen">
<div id="app" class="min-h-screen">
  <!-- HEADER -->
  <header class="w-full">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-wrap items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-2xl bg-gradient-to-br from-purple-500 via-fuchsia-500 to-sky-400
                    flex items-center justify-center font-extrabold text-white text-xl shadow-md">
          S
        </div>
        <div>
          <div class="flex flex-wrap items-center gap-2">
            <h1 id="portal-title" class="text-xl md:text-2xl font-semibold tracking-tight text-slate-900">
              Retail Team Scrum Portal
            </h1>
            <span class="text-[0.7rem] px-2 py-0.5 rounded-full bg-purple-50 border border-purple-200 text-purple-600">
              Live overview
            </span>
          </div>
          <p id="current-date" class="text-xs text-slate-500"></p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div id="timer-display"
             class="hidden items-center gap-2 px-3 py-1.5 rounded-full bg-white border border-slate-200 text-xs text-slate-600">
          <span>Standup timer</span>
          <span id="timer-text" class="font-semibold text-emerald-500">15:00</span>
        </div>

        <button id="start-scrum-btn"
                class="px-4 py-2 rounded-full bg-gradient-to-r from-purple-500 to-fuchsia-500
                       text-xs md:text-sm font-semibold text-white shadow-md hover:shadow-lg
                       transition-all flex items-center gap-1.5">
          üöÄ Start Scrum
        </button>

        <button id="add-update-btn"
                class="px-4 py-2 rounded-full bg-white border border-slate-200 text-xs md:text-sm
                       font-medium text-slate-800 hover:border-purple-400 hover:text-purple-600
                       flex items-center gap-1.5 transition-all">
          ‚ûï <span>Add update</span>
        </button>
      </div>
    </div>

    <!-- TABS -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-3 flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <button class="tab-btn pill active" data-tab="dashboard">
          <span class="dot"></span> Board
        </button>
        <button class="tab-btn pill" data-tab="summary">
          <span class="dot" style="background-color: var(--brand-accent-2);"></span> Summary
        </button>
        <button class="tab-btn pill" data-tab="manager">
          <span class="dot" style="background-color: var(--brand-accent-3);"></span> Manager view
        </button>
      </div>
      <div class="flex flex-wrap items-center gap-2 text-[0.7rem] text-slate-500">
        <span class="px-2 py-1 rounded-full bg-white border border-slate-200">
          ‚è±Ô∏è 15-min async + live standup
        </span>
        <span class="px-2 py-1 rounded-full bg-white border border-slate-200">
          üîê Powered by Supabase
        </span>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
    <!-- DASHBOARD TAB -->
    <section id="dashboard-tab" class="tab-content">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-lg md:text-xl font-semibold text-slate-900">Today's standup</h2>
          <p class="text-sm text-slate-500">
            Live cards for each team member‚Äôs latest update.
          </p>
        </div>
      </div>

      <div id="team-updates" class="grid gap-4 md:grid-cols-2 xl:grid-cols-3"></div>

      <div id="empty-state"
           class="mt-8 flex flex-col items-center justify-center gap-3 py-10 glass border-dashed">
        <div class="w-12 h-12 rounded-2xl bg-purple-50 flex items-center justify-center text-2xl text-purple-500">
          üìù
        </div>
        <h3 class="text-sm md:text-base font-medium text-slate-900">No updates yet for today</h3>
        <p class="text-xs md:text-sm text-slate-500">
          Kick things off by adding the first standup entry.
        </p>
        <button class="add-update-trigger px-4 py-2 rounded-full bg-gradient-to-r from-purple-500 to-fuchsia-500
                       text-xs md:text-sm font-semibold text-white shadow hover:shadow-lg transition-all">
          Add first update
        </button>
      </div>
    </section>

    <!-- SUMMARY TAB -->
    <section id="summary-tab" class="tab-content hidden">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 mb-4">
        <div>
          <h2 class="text-lg md:text-xl font-semibold text-slate-900">Summary & Export</h2>
          <p class="text-sm text-slate-500">
            See standups for a specific day or export a date range.
          </p>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <div class="flex items-center gap-1.5">
            <span class="text-label">Day:</span>
            <input type="date" id="summary-date"
                   class="field-input !px-3 !py-1.5 !rounded-full !text-xs" />
          </div>
          <div class="flex items-center gap-1.5">
            <span class="text-label">From:</span>
            <input type="date" id="range-from"
                   class="field-input !px-3 !py-1.5 !rounded-full !text-xs" />
            <span class="text-label">To:</span>
            <input type="date" id="range-to"
                   class="field-input !px-3 !py-1.5 !rounded-full !text-xs" />
          </div>
          <button id="export-range-btn"
                  class="px-4 py-1.5 rounded-full bg-emerald-500 hover:bg-emerald-400
                         text-[0.75rem] font-semibold text-white flex items-center gap-1.5">
            üìÑ Export CSV (range)
          </button>
        </div>
      </div>
      <div id="summary-content" class="space-y-4"></div>
    </section>

    <!-- MANAGER TAB -->
    <section id="manager-tab" class="tab-content hidden">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 mb-3">
        <div>
          <h2 class="text-lg md:text-xl font-semibold text-slate-900">Manager view</h2>
          <p class="text-sm text-slate-500">
            Filter by member, department or date. Quickly scan blockers and engagement.
          </p>
        </div>
      </div>

      <div class="glass p-4 mb-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
          <select id="filter-member" class="field-select">
            <option value="">All team members</option>
          </select>

          <select id="filter-department" class="field-select">
            <option value="">All departments</option>
            <option value="Management">Management</option>
            <option value="Retail / MM">Retail / MM</option>
            <option value="E-commerce">E-commerce</option>
            <option value="Logistics">Logistics</option>
            <option value="Fulfillment">Fulfillment</option>
            <option value="Operations">Operations</option>
            <option value="B2B">B2B</option>
          </select>

          <input type="date" id="filter-date" class="field-input" />
        </div>

        <div id="blocker-escalation-area" class="text-xs"></div>
      </div>

      <div id="manager-content" class="space-y-3"></div>
    </section>
  </main>

  <!-- CREATE / EDIT MODAL -->
  <div id="update-modal"
       class="fixed inset-0 z-40 hidden modal-overlay flex items-center justify-center px-3">
    <div class="glass max-w-xl w-full max-h-[90vh] overflow-y-auto p-5">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h3 id="modal-title" class="text-base font-semibold text-slate-900">
            New standup update
          </h3>
          <p class="text-xs text-slate-500">
            Use Shift+Enter to add a new bullet (‚Ä¢) on the next line.
          </p>
        </div>
        <button id="close-modal"
                class="w-7 h-7 rounded-full bg-slate-100 flex items-center justify-center
                       text-slate-500 hover:text-red-500 hover:bg-red-50 text-sm">
          ‚úï
        </button>
      </div>

      <form id="update-form" class="space-y-3 text-[0.85rem]">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="text-label mb-1 block">Date</label>
            <input type="date" id="update-date" name="date" required class="field-input" />
          </div>
          <div>
            <label class="text-label mb-1 block">Team member</label>
            <select id="team-member" name="team_member" required class="field-select">
              <option value="">Select</option>
              <!-- Filled from Supabase or fallback -->
            </select>
          </div>
        </div>

        <div>
          <label class="text-label mb-1 block">Department</label>
          <select id="department" name="department" required class="field-select">
            <option value="">Select department</option>
            <option value="Management">Management</option>
            <option value="Retail / MM">Retail / MM</option>
            <option value="E-commerce">E-commerce</option>
            <option value="Logistics">Logistics</option>
            <option value="Fulfillment">Fulfillment</option>
            <option value="Customer Exp">Customer Exp</option>
          </select>
        </div>

        <div>
          <label class="text-label mb-1 block">Yesterday's work</label>
          <textarea id="yesterday-work" name="yesterday_work"
                    placeholder="‚Ä¢ Completed store layout review"
                    class="field-textarea"></textarea>
        </div>

        <div>
          <label class="text-label mb-1 block">Today's plan</label>
          <textarea id="today-plan" name="today_plan"
                    placeholder="‚Ä¢ Launch promo for Category X"
                    class="field-textarea"></textarea>
        </div>

        <div>
          <label class="text-label mb-1 block">Blockers</label>
          <textarea id="blockers" name="blockers"
                    placeholder="‚Ä¢ Waiting on inventory confirmation"
                    class="field-textarea"></textarea>
        </div>

        <div>
          <label class="text-label mb-1 block">Remarks / notes</label>
          <textarea id="remarks" name="remarks"
                    placeholder="Optional context for managers"
                    class="field-textarea"></textarea>
        </div>

        <div class="flex justify-between items-center pt-2 gap-3">
          <button type="button" id="cancel-btn"
                  class="px-3 py-1.5 rounded-full bg-slate-100 text-slate-600 text-xs
                         hover:bg-slate-200 hover:text-slate-900">
            Cancel
          </button>
          <div class="flex items-center gap-2">
            <span id="edit-hint"
                  class="hidden text-[0.7rem] px-2 py-0.5 rounded-full bg-amber-50 text-amber-600 border border-amber-200">
              Editing existing entry
            </span>
            <button type="submit" id="save-btn"
                    class="px-4 py-1.5 rounded-full bg-gradient-to-r from-purple-500 to-fuchsia-500
                           text-xs md:text-sm font-semibold text-white flex items-center gap-1.5
                           hover:shadow-lg hover:shadow-purple-300/40 transition-all">
              <span id="save-text">Save update</span>
              <span id="save-loading" class="hidden">Saving‚Ä¶</span>
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- VIEW DETAIL MODAL -->
  <div id="view-modal"
       class="fixed inset-0 z-50 hidden modal-overlay flex items-center justify-center px-3">
    <div class="glass max-w-xl w-full max-h-[90vh] overflow-y-auto p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-semibold text-slate-900">Standup details</h3>
        <button id="close-view-modal"
                class="w-7 h-7 rounded-full bg-slate-100 flex items-center justify-center
                       text-slate-500 hover:text-red-500 hover:bg-red-50 text-sm">
          ‚úï
        </button>
      </div>
      <div id="view-modal-body" class="space-y-3 text-[0.9rem]"></div>
    </div>
  </div>
</div>

<script>
  // ========= CONFIG =========
  const defaultConfig = { meeting_duration: 15 };
  const SUPABASE_URL = "https://vzyiwazyqqgznyqfcbtt.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6eWl3YXp5cXFnem55cWZjYnR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MDAwMjQsImV4cCI6MjA3ODA3NjAyNH0.lGitaQYnskj8OcMR9MDsPL1n8oMOxunMQKwyjJEPOyg";

  const supabaseHeaders = {
    apikey: SUPABASE_ANON_KEY,
    Authorization: "Bearer " + SUPABASE_ANON_KEY,
    "Content-Type": "application/json",
    Prefer: "return=representation"
  };

  // name -> { department, color }
  let teamMembersIndex = {};
  let currentData = [];
  let timerInterval = null;
  let timerSeconds = 0;
  let isTimerRunning = false;
  let activeEditId = null;

  function esc(str) {
    return (str || "")
      .toString()
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  // ========= Supabase SDK wrapper =========
  window.dataSdk = {
    _handler: null,

    async init(handler) {
      this._handler = handler;
      try {
        await loadTeamMembers();

        const url =
          `${SUPABASE_URL}/rest/v1/scrum_updates` +
          `?select=id,date,team_member,department,yesterday_work,today_plan,blockers,remarks,created_at` +
          `&order=date.desc&order=created_at.desc`;

        const resp = await fetch(url, { headers: supabaseHeaders });
        if (!resp.ok) {
          console.error("Supabase GET failed", await resp.text());
          handler.onDataChanged([]);
          return { isOk: false };
        }

        const rows = await resp.json();
        const mapped = rows.map(r => ({
          id: r.id,
          date: r.date,
          team_member: r.team_member,
          department: r.department,
          yesterday_work: r.yesterday_work,
          today_plan: r.today_plan,
          blockers: r.blockers,
          remarks: r.remarks,
          created_at: r.created_at
        }));

        handler.onDataChanged(mapped);
        return { isOk: true };
      } catch (err) {
        console.error("Supabase init error", err);
        handler.onDataChanged([]);
        return { isOk: false };
      }
    },

    async create(row) {
      try {
        const resp = await fetch(
          `${SUPABASE_URL}/rest/v1/scrum_updates`,
          {
            method: "POST",
            headers: supabaseHeaders,
            body: JSON.stringify(row)
          }
        );
        if (!resp.ok) {
          console.error("Supabase INSERT failed:", await resp.text());
          return { isOk: false };
        }
        await this.init(this._handler);
        return { isOk: true };
      } catch (err) {
        console.error("Supabase create error", err);
        return { isOk: false };
      }
    },

    async update(id, partial) {
      try {
        const resp = await fetch(
          `${SUPABASE_URL}/rest/v1/scrum_updates?id=eq.${encodeURIComponent(id)}`,
          {
            method: "PATCH",
            headers: supabaseHeaders,
            body: JSON.stringify(partial)
          }
        );
        if (!resp.ok) {
          console.error("Supabase UPDATE failed:", await resp.text());
          return { isOk: false };
        }
        await this.init(this._handler);
        return { isOk: true };
      } catch (err) {
        console.error("Supabase update error", err);
        return { isOk: false };
      }
    }
  };

  // ========= Load team members from Supabase =========
  async function loadTeamMembers() {
    try {
      // IMPORTANT: expects table public.scrum_team_members(name, department, color, active)
      const url =
        `${SUPABASE_URL}/rest/v1/scrum_team_members` +
        `?select=name,department,color,active&order=name.asc`;

      const resp = await fetch(url, { headers: supabaseHeaders });

      if (!resp.ok) {
        console.error("scrum_team_members GET failed", await resp.text());
        applyFallbackTeamMembers();
        return;
      }

      const rows = await resp.json();
      if (!rows || !rows.length) {
        applyFallbackTeamMembers();
        return;
      }

      teamMembersIndex = {};
      rows
        .filter(r => r.active !== false)
        .forEach(r => {
          teamMembersIndex[r.name] = {
            department: r.department || "",
            color: r.color || randomColorForName(r.name)
          };
        });

      populateTeamMemberSelect();
    } catch (err) {
      console.error("Error loading scrum_team_members:", err);
      applyFallbackTeamMembers();
    }
  }

  function applyFallbackTeamMembers() {
    teamMembersIndex = {
      "Amrit":   { department: "Management",   color: "#38bdf8" },
      "Vihan":   { department: "Retail / MM",  color: "#22c55e" },
      "Maricel": { department: "E-commerce",   color: "#fb923c" },
      "Kunal":   { department: "Logistics",    color: "#6366f1" },
      "Mehboob": { department: "Fulfillment",  color: "#a855f7" },
      "Aaron":   { department: "Customer Exp", color: "#f97316" }
    };
    populateTeamMemberSelect();
  }

  function populateTeamMemberSelect() {
    const select = document.getElementById("team-member");
    if (!select) return;
    const current = select.value;

    select.innerHTML =
      '<option value="">Select</option>' +
      Object.keys(teamMembersIndex)
        .map(name => `<option value="${esc(name)}">${esc(name)}</option>`)
        .join("");

    if (current && teamMembersIndex[current]) {
      select.value = current;
    }
  }

  function randomColorForName(name) {
    const colors = ["#7c3aed","#22c55e","#06b6d4","#f97316","#e11d48","#6366f1"];
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
      hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    return colors[Math.abs(hash) % colors.length];
  }

  const dataHandler = {
    onDataChanged(data) {
      currentData = data;
      updateUI();
    }
  };

  // ========= INIT =========
  document.addEventListener("DOMContentLoaded", initializeApp);

  async function initializeApp() {
    updateCurrentDate();
    updateTimerDisplay();
    setupStaticListeners();
    setupBulletEnhancers();

    const today = new Date().toISOString().split("T")[0];
    document.getElementById("update-date").value = today;
    document.getElementById("summary-date").value = today;
    document.getElementById("filter-date").value = today;
    document.getElementById("range-from").value = today;
    document.getElementById("range-to").value = today;

    const initResult = await window.dataSdk.init(dataHandler);
    if (!initResult.isOk) {
      console.error("Failed to init data from Supabase");
    }
  }

  // ========= LISTENERS =========
  function setupStaticListeners() {
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => switchTab(btn.dataset.tab));
    });

    document.getElementById("add-update-btn")
      .addEventListener("click", () => openModal());
    document.querySelector(".add-update-trigger")
      ?.addEventListener("click", () => openModal());

    document.getElementById("close-modal").addEventListener("click", closeModal);
    document.getElementById("cancel-btn").addEventListener("click", closeModal);
    document.getElementById("update-form").addEventListener("submit", handleFormSubmit);

    document.getElementById("start-scrum-btn").addEventListener("click", toggleTimer);

    document.getElementById("filter-member").addEventListener("change", applyFilters);
    document.getElementById("filter-department").addEventListener("change", applyFilters);
    document.getElementById("filter-date").addEventListener("change", applyFilters);

    document.getElementById("summary-date").addEventListener("change", updateSummaryView);
    document.getElementById("export-range-btn").addEventListener("click", exportRange);

    document.getElementById("close-view-modal")
      .addEventListener("click", closeViewModal);

    // close view modal on background click
    document.getElementById("view-modal").addEventListener("click", e => {
      if (e.target.id === "view-modal") closeViewModal();
    });
  }

  function setupBulletEnhancers() {
    ["yesterday-work", "today-plan", "blockers", "remarks"].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("keydown", e => {
        if (e.key === "Enter" && e.shiftKey) {
          e.preventDefault();
          const { selectionStart, selectionEnd, value } = el;
          const prefix = "‚Ä¢ ";
          const before = value.slice(0, selectionStart);
          const after = value.slice(selectionEnd);
          const needsNewLine = before.length > 0 && !before.endsWith("\n");
          const insert = (needsNewLine ? "\n" : "") + prefix;
          el.value = before + insert + after;
          const pos = before.length + insert.length;
          el.setSelectionRange(pos, pos);
        }
      });
    });
  }

  // ========= FORM (CREATE / EDIT) =========
  async function handleFormSubmit(e) {
    e.preventDefault();

    if (currentData.length >= 999) {
      showToast("Max 999 updates reached. Clean old entries.", "error");
      return;
    }

    const saveBtn = document.getElementById("save-btn");
    const saveText = document.getElementById("save-text");
    const saveLoading = document.getElementById("save-loading");

    saveBtn.disabled = true;
    saveText.classList.add("hidden");
    saveLoading.classList.remove("hidden");

    try {
      const formData = new FormData(e.target);

      const payload = {
        date: formData.get("date"),
        team_member: formData.get("team_member"),
        department: formData.get("department"),
        yesterday_work: formData.get("yesterday_work") || "",
        today_plan: formData.get("today_plan") || "",
        blockers: formData.get("blockers") || "",
        remarks: formData.get("remarks") || "",
        created_at: new Date().toISOString()
      };

      let result;
      if (activeEditId) {
        delete payload.created_at;
        result = await window.dataSdk.update(activeEditId, payload);
      } else {
        result = await window.dataSdk.create(payload);
      }

      if (result.isOk) {
        closeModal();
        showToast(activeEditId ? "Update saved." : "New entry added.", "success");
      } else {
        showToast("Failed to save update. Check Supabase settings.", "error");
      }
    } catch (err) {
      console.error(err);
      showToast("Unexpected error while saving.", "error");
    } finally {
      saveBtn.disabled = false;
      saveText.classList.remove("hidden");
      saveLoading.classList.add("hidden");
    }
  }

  // ========= UI RENDER =========
  function updateUI() {
    updateDashboard();
    updateManagerPanel();
    updateSummaryView();
  }

  function updateDashboard() {
    const container = document.getElementById("team-updates");
    const emptyState = document.getElementById("empty-state");
    const today = new Date().toISOString().split("T")[0];

    const todayUpdates = currentData.filter(u => u.date === today);

    if (!todayUpdates.length) {
      container.innerHTML = "";
      emptyState.classList.remove("hidden");
      return;
    }

    emptyState.classList.add("hidden");

    const latestByMember = {};
    todayUpdates.forEach(u => {
      if (!latestByMember[u.team_member] ||
          new Date(u.created_at) > new Date(latestByMember[u.team_member].created_at)) {
        latestByMember[u.team_member] = u;
      }
    });

    container.innerHTML = Object.values(latestByMember)
      .map(u => createUpdateCard(u))
      .join("");

    container.querySelectorAll("[data-edit-id]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.editId;
        const row = currentData.find(r => String(r.id) === String(id));
        if (row) openModal(row);
      });
    });

    container.querySelectorAll("[data-view-id]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.viewId;
        const row = currentData.find(r => String(r.id) === String(id));
        if (row) openViewModal(row);
      });
    });
  }

  function createUpdateCard(update) {
    const tm = teamMembersIndex[update.team_member] || {};
    const color = tm.color || "#6366f1";
    const dept = update.department || tm.department || "";
    const hasBlockers = !!(update.blockers && update.blockers.trim());
    const initials = update.team_member
      ? update.team_member.split(" ").map(n => n[0]).join("")
      : "?";

    return `
      <article class="scrum-card p-4 flex flex-col gap-3">
        <div class="flex items-start justify-between gap-2">
          <div class="flex items-center gap-3">
            <div class="relative">
              <div class="avatar" style="background: linear-gradient(135deg, ${color}, #a855f7);">
                ${esc(initials)}
              </div>
              <div class="status-indicator ${hasBlockers ? "bg-rose-500" : "bg-emerald-400"}"></div>
            </div>
            <div>
              <div class="flex items-center gap-1.5">
                <h3 class="text-sm md:text-base font-semibold text-slate-900">
                  ${esc(update.team_member || "Unassigned")}
                </h3>
                ${hasBlockers
                  ? `<span class="px-2 py-0.5 rounded-full bg-rose-50 text-rose-600 text-[0.7rem]">‚ö† Blocker</span>`
                  : `<span class="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-600 text-[0.7rem]">‚úì Clear</span>`}
              </div>
              ${dept ? `
                <span class="department-pill">
                  <span class="w-1.5 h-1.5 rounded-full" style="background-color:${color};"></span>
                  ${esc(dept)}
                </span>` : ""}
            </div>
          </div>
          <div class="flex flex-col items-end gap-1">
            <button class="text-[0.7rem] px-2 py-0.5 rounded-full bg-white border border-slate-200
                           text-slate-600 hover:text-purple-600 hover:border-purple-400 transition-all"
                    data-view-id="${esc(update.id)}">
              View
            </button>
            <button class="text-[0.65rem] px-2 py-0.5 rounded-full bg-slate-50 border border-slate-200
                           text-slate-500 hover:text-purple-600 hover:border-purple-400 transition-all"
                    data-edit-id="${esc(update.id)}">
              ‚úè Edit
            </button>
          </div>
        </div>

        <div class="space-y-1.5 text-[0.8rem]">
          <div>
            <p class="text-label">Yesterday</p>
            <p class="text-slate-800 multiline">
              ${esc(update.yesterday_work || "No update provided.")}
            </p>
          </div>
          <div>
            <p class="text-label">Today</p>
            <p class="text-slate-800 multiline">
              ${esc(update.today_plan || "No plan specified.")}
            </p>
          </div>
          <div>
            <p class="text-label">Blockers</p>
            <p class="${hasBlockers ? "text-rose-600" : "text-slate-500"} multiline">
              ${esc(update.blockers || "None")}
            </p>
          </div>
          ${update.remarks ? `
            <div>
              <p class="text-label">Notes</p>
              <p class="text-purple-700 multiline">${esc(update.remarks)}</p>
            </div>` : ""}
        </div>

        <div class="flex justify-between items-center text-[0.7rem] text-slate-500 pt-1">
          <span>${update.date ? esc(update.date) : ""}</span>
          <span>
            ${update.created_at
              ? new Date(update.created_at).toLocaleTimeString("en-US", {hour:"2-digit", minute:"2-digit"})
              : ""}
          </span>
        </div>
      </article>
    `;
  }

  // ========= VIEW MODAL =========
  function openViewModal(row) {
    const modal = document.getElementById("view-modal");
    const body = document.getElementById("view-modal-body");
    const tm = teamMembersIndex[row.team_member] || {};
    const color = tm.color || "#6366f1";
    const dept = row.department || tm.department || "";
    const initials = row.team_member
      ? row.team_member.split(" ").map(n => n[0]).join("")
      : "?";

    body.innerHTML = `
      <div class="flex items-center gap-3 mb-2">
        <div class="w-10 h-10 rounded-2xl flex items-center justify-center text-white text-sm font-semibold"
             style="background: linear-gradient(135deg, ${color}, #a855f7);">
          ${esc(initials)}
        </div>
        <div>
          <div class="flex items-center gap-2">
            <div class="font-semibold text-slate-900">${esc(row.team_member || "Unassigned")}</div>
            ${dept ? `
              <span class="px-2 py-0.5 rounded-full bg-slate-50 border border-slate-200 text-[0.7rem] text-slate-700">
                ${esc(dept)}
              </span>` : ""}
          </div>
          <div class="text-[0.75rem] text-slate-500">
            ${row.date ? `For ${esc(row.date)}` : ""}
          </div>
        </div>
      </div>

      <div class="space-y-2 text-[0.85rem]">
        <div>
          <div class="text-label">Yesterday's work</div>
          <div class="text-slate-800 multiline">
            ${esc(row.yesterday_work || "No update provided.")}
          </div>
        </div>
        <div>
          <div class="text-label">Today's plan</div>
          <div class="text-slate-800 multiline">
            ${esc(row.today_plan || "No plan specified.")}
          </div>
        </div>
        <div>
          <div class="text-label">Blockers</div>
          <div class="${row.blockers ? "text-rose-600" : "text-slate-500"} multiline">
            ${esc(row.blockers || "None")}
          </div>
        </div>
        ${row.remarks ? `
          <div>
            <div class="text-label">Remarks / notes</div>
            <div class="text-purple-700 multiline">
              ${esc(row.remarks)}
            </div>
          </div>` : ""}
        <div class="pt-2 text-[0.75rem] text-slate-500">
          Created at:
          ${row.created_at ? new Date(row.created_at).toLocaleString() : "N/A"}
        </div>
      </div>
    `;

    modal.classList.remove("hidden");
  }

  function closeViewModal() {
    document.getElementById("view-modal").classList.add("hidden");
  }

  // ========= SUMMARY / EXPORT RANGE =========
  function updateSummaryView() {
    const selectedDate = document.getElementById("summary-date").value;
    const container = document.getElementById("summary-content");
    if (!selectedDate) {
      container.innerHTML = "";
      return;
    }

    const dayUpdates = currentData.filter(u => u.date === selectedDate);

    if (!dayUpdates.length) {
      container.innerHTML = `
        <div class="glass p-6 flex flex-col items-center gap-2">
          <div class="w-10 h-10 rounded-2xl bg-purple-50 flex items-center justify-center text-2xl text-purple-500">üìÖ</div>
          <p class="text-sm text-slate-900">No updates for ${esc(selectedDate)}.</p>
          <p class="text-xs text-slate-500">
            Ask the team to submit standup entries, or pick another date.
          </p>
        </div>`;
      return;
    }

    const groups = {};
    dayUpdates.forEach(u => {
      if (!groups[u.team_member]) groups[u.team_member] = [];
      groups[u.team_member].push(u);
    });

    container.innerHTML = `
      <div class="glass p-5 space-y-4">
        <h3 class="text-sm md:text-base font-semibold text-slate-900">
          Standup summary ‚Äî ${
            new Date(selectedDate).toLocaleDateString("en-US", {
              weekday:"long", month:"short", day:"numeric", year:"numeric"
            })
          }
        </h3>
        ${
          Object.entries(groups).map(([member, list]) => {
            const latest = list.sort((a,b) =>
              new Date(b.created_at) - new Date(a.created_at))[0];
            const tm = teamMembersIndex[member] || {};
            const color = tm.color || "#64748b";
            const dept = latest.department || tm.department || "Dept";
            const hasBlockers = latest.blockers && latest.blockers.trim();
            return `
              <div class="border-l-2 pl-3 space-y-1.5" style="border-color:${color};">
                <div class="flex items-center gap-2">
                  <span class="text-sm font-semibold text-slate-900">
                    ${esc(member || "Unassigned")}
                  </span>
                  <span class="text-[0.7rem] px-2 py-0.5 rounded-full bg-slate-50 border border-slate-200 text-slate-700">
                    ${esc(dept)}
                  </span>
                </div>
                <div class="grid md:grid-cols-3 gap-2 text-[0.8rem]">
                  <div>
                    <div class="text-label">Yesterday</div>
                    <div class="text-slate-800 multiline">
                      ${esc(latest.yesterday_work || "No update")}
                    </div>
                  </div>
                  <div>
                    <div class="text-label">Today</div>
                    <div class="text-slate-800 multiline">
                      ${esc(latest.today_plan || "No plan")}
                    </div>
                  </div>
                  <div>
                    <div class="text-label">Blockers</div>
                    <div class="${hasBlockers ? "text-rose-600" : "text-slate-500"} multiline">
                      ${esc(latest.blockers || "None")}
                    </div>
                  </div>
                </div>
                ${latest.remarks ? `
                  <div class="text-[0.75rem] text-purple-700 multiline">
                    Notes: ${esc(latest.remarks)}
                  </div>` : ""}
              </div>
            `;
          }).join("")
        }
      </div>
    `;
  }

  function exportRange() {
    const from = document.getElementById("range-from").value;
    const to = document.getElementById("range-to").value;

    if (!from || !to) {
      showToast("Select both From and To dates.", "error");
      return;
    }

    const fromDate = new Date(from);
    const toDate = new Date(to);
    if (fromDate > toDate) {
      showToast("From date cannot be after To date.", "error");
      return;
    }

    const rows = currentData.filter(u => {
      if (!u.date) return false;
      const d = new Date(u.date);
      return d >= fromDate && d <= toDate;
    });

    if (!rows.length) {
      showToast("No records in that range.", "error");
      return;
    }

    const headers = [
      "date",
      "team_member",
      "department",
      "yesterday_work",
      "today_plan",
      "blockers",
      "remarks",
      "created_at"
    ];

    const lines = [
      headers.join(","),
      ...rows.map(r => [
        r.date,
        r.team_member,
        r.department,
        (r.yesterday_work || "").replace(/"/g, '""'),
        (r.today_plan || "").replace(/"/g, '""'),
        (r.blockers || "").replace(/"/g, '""'),
        (r.remarks || "").replace(/"/g, '""'),
        r.created_at || ""
      ].map(v => `"${v || ""}"`).join(","))
    ];

    const blob = new Blob([lines.join("\n")], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `scrum-summary-${from}_to_${to}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showToast("Range exported.", "success");
  }

  // ========= MANAGER VIEW =========
  function updateManagerPanel() {
    populateFilterDropdowns();
    applyFilters();
  }

  function populateFilterDropdowns() {
    const memberSelect = document.getElementById("filter-member");
    const unique = [...new Set(currentData.map(u => u.team_member).filter(Boolean))];

    memberSelect.innerHTML =
      `<option value="">All team members</option>` +
      unique.map(m => `<option value="${esc(m)}">${esc(m)}</option>`).join("");
  }

  function applyFilters() {
    const member = document.getElementById("filter-member").value;
    const dept = document.getElementById("filter-department").value;
    const date = document.getElementById("filter-date").value;

    let items = [...currentData];

    if (member) items = items.filter(u => u.team_member === member);
    if (dept) items = items.filter(u => u.department === dept);
    if (date) items = items.filter(u => u.date === date);

    displayManagerContent(items);
  }

  function displayManagerContent(data) {
    const container = document.getElementById("manager-content");
    const blockerArea = document.getElementById("blocker-escalation-area");

    if (!data.length) {
      blockerArea.innerHTML = "";
      container.innerHTML = `
        <div class="glass p-6 flex flex-col items-center gap-2">
          <div class="w-10 h-10 rounded-2xl bg-purple-50 flex items-center justify-center text-2xl text-purple-500">üîç</div>
          <p class="text-sm text-slate-900">No entries match the current filters.</p>
          <p class="text-xs text-slate-500">Adjust filters to see more.</p>
        </div>`;
      return;
    }

    const openBlockers = data.filter(u => u.blockers && u.blockers.trim());
    if (openBlockers.length) {
      blockerArea.innerHTML = `
        <div class="rounded-2xl bg-rose-50 border border-rose-200 px-3 py-2 text-[0.75rem] text-rose-700">
          <div class="font-semibold mb-1 flex items-center gap-1.5">
            üö® ${openBlockers.length} blocker${openBlockers.length>1?"s":""} need attention
          </div>
          <ul class="list-disc pl-4 space-y-0.5">
            ${
              openBlockers.slice(0,6).map(b => `
                <li>
                  <span class="font-semibold">${esc(b.team_member)}</span>
                  <span class="text-slate-500"> (${esc(b.department || "")})</span> ‚Äî
                  ${esc(b.blockers)}
                </li>`).join("")
            }
          </ul>
        </div>`;
    } else {
      blockerArea.innerHTML = "";
    }

    const total = data.length;
    const uniqueMembers = new Set(data.map(u => u.team_member)).size;

    container.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3 text-[0.8rem]">
        <div class="glass px-3 py-2">
          <div class="text-slate-500">Total updates</div>
          <div class="text-xl font-semibold text-slate-900">${total}</div>
        </div>
        <div class="glass px-3 py-2">
          <div class="text-slate-500">Active members</div>
          <div class="text-xl font-semibold text-emerald-500">${uniqueMembers}</div>
        </div>
        <div class="glass px-3 py-2">
          <div class="text-slate-500">Open blockers</div>
          <div class="text-xl font-semibold ${openBlockers.length ? "text-rose-500" : "text-slate-400"}">
            ${openBlockers.length}
          </div>
        </div>
      </div>

      <div class="space-y-2">
        ${
          data.map(u => {
            const tm = teamMembersIndex[u.team_member] || {};
            const color = tm.color || "#64748b";
            const hasBlockers = u.blockers && u.blockers.trim();
            const initials = u.team_member
              ? u.team_member.split(" ").map(n => n[0]).join("")
              : "?";
            return `
              <div class="glass px-3 py-2 flex flex-col gap-1.5 text-[0.8rem]">
                <div class="flex items-start justify-between gap-2">
                  <div class="flex items-center gap-2">
                    <div class="w-7 h-7 rounded-xl flex items-center justify-center text-[0.7rem] text-white"
                         style="background: linear-gradient(135deg, ${color}, #a855f7);">
                      ${esc(initials)}
                    </div>
                    <div>
                      <div class="flex items-center gap-1.5">
                        <span class="font-semibold text-slate-900">${esc(u.team_member || "Unassigned")}</span>
                        <span class="px-1.5 py-0.5 rounded-full bg-slate-50 text-slate-600 border border-slate-200">
                          ${esc(u.department || "")}
                        </span>
                      </div>
                      <div class="text-slate-500 text-[0.7rem]">
                        ${esc(u.date || "")}
                        ${hasBlockers ? " ‚Ä¢ ‚ö† Blocker" : ""}
                      </div>
                    </div>
                  </div>
                  <div class="flex flex-col items-end gap-1">
                    <button class="px-2 py-0.5 rounded-full bg-white text-slate-500 hover:text-purple-600
                                   hover:border-purple-400 border border-slate-200 text-[0.7rem]"
                            data-view-id="${esc(u.id)}">
                      View
                    </button>
                    <button class="px-2 py-0.5 rounded-full bg-slate-50 text-slate-500 hover:text-purple-600
                                   hover:border-purple-400 border border-slate-200 text-[0.7rem]"
                            data-edit-id="${esc(u.id)}">
                      Edit
                    </button>
                  </div>
                </div>
                <div class="grid md:grid-cols-2 gap-1.5">
                  <div>
                    <span class="text-label">Yesterday:</span>
                    <span class="text-slate-800 multiline"> ${esc(u.yesterday_work || "‚Äî")} </span>
                  </div>
                  <div>
                    <span class="text-label">Today:</span>
                    <span class="text-slate-800 multiline"> ${esc(u.today_plan || "‚Äî")} </span>
                  </div>
                </div>
                ${hasBlockers ? `
                  <div class="text-rose-600 multiline">
                    <span class="font-medium">Blocker:</span> ${esc(u.blockers)}
                  </div>` : ""}
                ${u.remarks ? `
                  <div class="text-purple-700 multiline">
                    <span class="font-medium">Notes:</span> ${esc(u.remarks)}
                  </div>` : ""}
              </div>
            `;
          }).join("")
        }
      </div>
    `;

    container.querySelectorAll("[data-edit-id]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.editId;
        const row = currentData.find(r => String(r.id) === String(id));
        if (row) openModal(row);
      });
    });
    container.querySelectorAll("[data-view-id]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.viewId;
        const row = currentData.find(r => String(r.id) === String(id));
        if (row) openViewModal(row);
      });
    });
  }

  // ========= GENERAL HELPERS =========
  function updateCurrentDate() {
    const now = new Date();
    document.getElementById("current-date").textContent =
      now.toLocaleDateString("en-US", {
        weekday:"long", month:"short", day:"numeric", year:"numeric"
      });
  }

  function toggleTimer() {
    const btn = document.getElementById("start-scrum-btn");
    const timerDisplay = document.getElementById("timer-display");

    if (!isTimerRunning) {
      timerSeconds = defaultConfig.meeting_duration * 60;
      isTimerRunning = true;
      btn.textContent = "‚èπ Stop Scrum";
      btn.classList.add("timer-active");
      timerDisplay.classList.remove("hidden");

      timerInterval = setInterval(() => {
        timerSeconds--;
        updateTimerDisplay();
        if (timerSeconds <= 0) {
          clearInterval(timerInterval);
          isTimerRunning = false;
          btn.textContent = "üöÄ Start Scrum";
          btn.classList.remove("timer-active");
          timerDisplay.classList.add("hidden");
          showToast("Standup timer finished.", "success");
        }
      }, 1000);
    } else {
      clearInterval(timerInterval);
      isTimerRunning = false;
      btn.textContent = "üöÄ Start Scrum";
      btn.classList.remove("timer-active");
      timerDisplay.classList.add("hidden");
    }
  }

  function updateTimerDisplay() {
    const minutes = Math.floor(timerSeconds / 60);
    const seconds = timerSeconds % 60;
    const s = `${String(minutes).padStart(2,"0")}:${String(seconds).padStart(2,"0")}`;
    const el = document.getElementById("timer-text");
    if (el) el.textContent = s;
  }

  function switchTab(tabName) {
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.classList.remove("active");
    });
    const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
    if (activeBtn) activeBtn.classList.add("active");

    document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
    const target = document.getElementById(`${tabName}-tab`);
    if (target) target.classList.remove("hidden");

    if (tabName === "summary") updateSummaryView();
    if (tabName === "manager") updateManagerPanel();
  }

  function showToast(message, type = "info") {
    const base =
      "fixed top-4 right-4 z-50 px-3 py-2 rounded-2xl text-[0.8rem] font-medium " +
      "shadow-lg bg-white border transform translate-x-full opacity-0 transition-all";
    const colors = {
      success: "border-emerald-200 text-emerald-700",
      error: "border-rose-200 text-rose-700",
      info: "border-sky-200 text-sky-700"
    };

    const toast = document.createElement("div");
    toast.className = base + " " + (colors[type] || colors.info);
    toast.textContent = message;
    document.body.appendChild(toast);

    requestAnimationFrame(() => {
      toast.classList.remove("translate-x-full", "opacity-0");
    });

    setTimeout(() => {
      toast.classList.add("translate-x-full", "opacity-0");
      setTimeout(() => toast.remove(), 220);
    }, 2600);
  }

  function openModal(existing) {
    const modal = document.getElementById("update-modal");
    const title = document.getElementById("modal-title");
    const editHint = document.getElementById("edit-hint");
    const saveText = document.getElementById("save-text");

    if (existing) {
      activeEditId = existing.id;
      title.textContent = "Edit standup update";
      editHint.classList.remove("hidden");
      saveText.textContent = "Save changes";

      document.getElementById("update-date").value = existing.date || "";
      document.getElementById("team-member").value = existing.team_member || "";
      document.getElementById("department").value = existing.department || "";
      document.getElementById("yesterday-work").value = existing.yesterday_work || "";
      document.getElementById("today-plan").value = existing.today_plan || "";
      document.getElementById("blockers").value = existing.blockers || "";
      document.getElementById("remarks").value = existing.remarks || "";
    } else {
      activeEditId = null;
      title.textContent = "New standup update";
      editHint.classList.add("hidden");
      saveText.textContent = "Save update";

      const today = new Date().toISOString().split("T")[0];
      document.getElementById("update-date").value = today;
      document.getElementById("team-member").value = "";
      document.getElementById("department").value = "";
      document.getElementById("yesterday-work").value = "";
      document.getElementById("today-plan").value = "";
      document.getElementById("blockers").value = "";
      document.getElementById("remarks").value = "";
    }

    modal.classList.remove("hidden");
  }

  function closeModal() {
    activeEditId = null;
    document.getElementById("update-modal").classList.add("hidden");
  }
</script>
</body>
</html>
